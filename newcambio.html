<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Airconekta ¬∑ Solicitar Cambio</title>
  <meta name="theme-color" content="#ffffff" />
  <meta name="color-scheme" content="light">
  <meta name="description" content="Formulario para solicitar cambio de domicilio de servicio y enviar datos v√≠a WhatsApp.">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='56' fill='%23ffffff'/%3E%3Cpath fill='%23246bff' d='M192 76a8 8 0 0 1 8 8v88a8 8 0 0 1-8 8H64a8 8 0 0 1-8-8V84a8 8 0 0 1 8-8h128zm-16 24H80v72h96V100zM92 72h72a4 4 0 0 1 0 8H92a4 4 0 1 1 0-8z'/%3E%3C/svg%3E" />
  <style>
    :root{
      --bg: #ffffff;
      --bg-2: #ffffff;
      --ink: #0f1a2e;
      --muted: #5b6b86;
      --accent: #246bff;
      --border: #cfe0ff;
      --ok: #1f9d55;
      --radius: 18px;
      --shadow: 0 10px 26px rgba(16,48,96,.10);
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:#fff;
      color:var(--ink);
    }

    .shell{ max-width:920px; margin:0 auto; padding:24px; }

    .nav{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:16px 18px; border-radius:var(--radius);
      background:var(--bg-2);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      position:sticky; top:12px; backdrop-filter:saturate(110%);
    }
    .brand{ display:flex; gap:12px; align-items:center; font-weight:800; letter-spacing:.2px; color:var(--ink); }
    .brand .logo{ width:36px; height:36px; border-radius:12px; display:grid; place-items:center; background:#fff; border:1px solid var(--border); color:var(--accent); }
    .brand .logo span{ font-size:18px; }

    .card{
      margin-top:24px; padding:22px; border-radius:22px;
      background:var(--bg-2);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
    }

    h1{ font-size:1.5rem; margin:0 0 6px; color:var(--ink); }
    .lead{ color:var(--muted); margin:0 0 16px; }

    form{ display:grid; grid-template-columns:repeat(12,1fr); gap:14px; }
    .col-12{ grid-column:span 12; }
    .col-6{ grid-column:span 6; }
    @media (max-width:860px){ .col-6{ grid-column:span 12; } }

    label{ display:block; font-size:.92rem; color:var(--muted); margin:4px 0 6px; }
    input,textarea,select{
      width:100%; padding:12px 14px; border-radius:14px;
      border:1px solid var(--border); background:#fff; color:var(--ink);
      outline:none; transition:border .15s ease, box-shadow .15s ease, transform .06s ease;
      font-family:inherit; font-size:1rem;
      resize:vertical;
    }
    input:focus,textarea:focus,select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(36,107,255,.12);
      background:#fff;
    }
    input:active,textarea:active,select:active{ transform:translateY(.5px); }

    .inline{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

    .btn{
      appearance:none; cursor:pointer; user-select:none;
      border:1px solid var(--accent); color:var(--accent);
      background:#fff;
      padding:12px 16px; border-radius:14px; font-weight:700; letter-spacing:.2px;
      transition: background .15s ease, color .15s ease, box-shadow .15s ease, transform .06s ease;
      text-decoration:none;
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
    }
    .btn:hover{ background:rgba(36,107,255,.06); box-shadow:0 0 0 3px rgba(36,107,255,.12); }
    .btn:active{ transform:translateY(1px); }

    .btn-primary{
      background:var(--accent); color:#fff; border-color:var(--accent);
    }
    .btn-primary:hover{ box-shadow:0 0 0 3px rgba(36,107,255,.20); }

    .status{ font-size:.9rem; color:var(--muted); }

    .footer{
      margin:20px 0 0; color:var(--muted); font-size:.9rem;
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;
    }

    .toast{
      position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(16px); opacity:0; pointer-events:none;
      background:#fff; color:var(--ink); padding:10px 14px; border-radius:12px;
      border:1px solid var(--accent); box-shadow:0 8px 20px rgba(16,48,96,.10); transition:.18s ease;
      z-index:20;
    }
    .toast.show{ transform:translateX(-50%) translateY(0); opacity:1; }
  </style>
</head>
<body>
  <div class="shell">
    <nav class="nav">
      <div class="brand">
        <div class="logo"><span>‚ö°</span></div>
        <div>Airconekta <span style="opacity:.65;font-weight:600">Cambio</span></div>
      </div>
      <div class="inline">
        <button id="installBtn" class="btn" style="display:none">‚ûï Instalar</button>
        <a class="btn" href="#" id="shareBtn" title="Compartir app">‚á™ Compartir</a>
      </div>
    </nav>

    <section class="card">
      <h1>Solicitar cambio de domicilio</h1>
      <p class="lead">
        Llena los datos para solicitar el cambio de domicilio de tu servicio. Al finalizar se abrir√° WhatsApp con tu informaci√≥n lista para enviar.
      </p>

      <form id="form" novalidate>
        <div class="col-12">
          <label for="nombre">Nombre completo</label>
          <input id="nombre" name="nombre" placeholder="Tu nombre" required autocomplete="name" />
        </div>

        <div class="col-6">
          <label for="telefono">Tel√©fono de contacto</label>
          <input id="telefono" name="telefono" inputmode="numeric" autocomplete="tel"
                 placeholder="10 d√≠gitos" pattern="[0-9]{10}"
                 title="Debe contener exactamente 10 d√≠gitos (solo n√∫meros 0-9)" required />
        </div>

        <div class="col-6">
          <label for="fecha">Fecha en la que nos puede recibir</label>
          <input id="fecha" name="fecha" type="date" required />
        </div>

        <!-- CAMBIO: input time -> select con ayuda -->
        <div class="col-6">
          <label for="hora">Hora en la que nos puede recibir</label>
          <select id="hora" name="hora" required>
            <option value="">Selecciona una fecha primero</option>
          </select>
          <small id="horaHelp" class="status"></small>
        </div>

        <div class="col-12">
          <label for="domicilioActual">Domicilio actual completo</label>
          <textarea id="domicilioActual" name="domicilioActual" rows="3"
                    placeholder="Calle, n√∫mero, colonia, ciudad, CP"
                    required></textarea>
        </div>

        <div class="col-12">
          <label for="domicilioNuevo">Nuevo domicilio completo</label>
          <textarea id="domicilioNuevo" name="domicilioNuevo" rows="3"
                    placeholder="Calle, n√∫mero, colonia, ciudad, CP"
                    required></textarea>
        </div>

        <div class="col-12">
          <label for="comentarios">Comentarios adicionales (opcional)</label>
          <textarea id="comentarios" name="comentarios" rows="3"
                    placeholder="Referencias, detalles de acceso, etc. (opcional)"></textarea>
        </div>

        <div class="col-12">
          <button type="submit" class="btn btn-primary" id="sendBtn">üì® Enviar solicitud por WhatsApp</button>
        </div>
      </form>

      <div id="toast" class="toast" role="status" aria-live="polite"></div>
    </section>

    <div class="footer">
      <span>¬© <span id="year"></span> Airconekta</span>
      <span style="opacity:.75">Hecho con ‚ù§Ô∏è para clientes felices</span>
    </div>
  </div>

  <script>
    // Peque√±os helpers globales
    const $ = sel => document.querySelector(sel);
    const toast = (msg) => {
      const t = $('#toast');
      if (!t) return;
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1800);
    };

    // Todo el c√≥digo se ejecuta despu√©s de que cargue el DOM
    window.addEventListener('DOMContentLoaded', () => {
      // Configuraci√≥n
      const NUMERO_DESTINO = "5213222108817";

      // A√±o din√°mico
      const yearEl = $('#year');
      if (yearEl) {
        yearEl.textContent = new Date().getFullYear();
      }

      function validarFormulario() {
        const form = $('#form');
        if (!form.checkValidity()) {
          form.reportValidity();
          return false;
        }
        const telefono = $('#telefono').value.replace(/\D+/g, '');
        if (telefono.length !== 10) {
          toast('El tel√©fono debe tener 10 d√≠gitos');
          $('#telefono').focus();
          return false;
        }
        const fecha = $('#fecha').value;
        const hora = $('#hora').value;
        if (!fecha) {
          toast('Selecciona una fecha');
          $('#fecha').focus();
          return false;
        }
        if (!hora) {
          toast('Selecciona una hora disponible');
          $('#hora').focus();
          return false;
        }
        return true;
      }

      // üîó URL del WebApp de Google Apps Script
      const CALENDAR_API_URL = "https://script.google.com/macros/s/AKfycbyv9vI_FygymYYbNw_jy-W7-O9eRto85-Vf-vgGNsejf3czO9kEuaaFdylCH9QytcQF/exec";

      async function cargarHorasDisponibles() {
        const fechaInput = $('#fecha');
        const horaSelect = $('#hora');
        const help = $('#horaHelp');

        const date = fechaInput.value;
        if (!date) {
          horaSelect.innerHTML = '<option value="">Selecciona una fecha primero</option>';
          help.textContent = '';
          return;
        }

        // Limpia el select mientras carga
        horaSelect.innerHTML = '<option value="">Cargando horas disponibles‚Ä¶</option>';
        help.textContent = '';

        try {
          const res = await fetch(`${CALENDAR_API_URL}?date=${encodeURIComponent(date)}`);
          const data = await res.json();

          const slots = data.slots || [];

          if (!slots.length) {
            horaSelect.innerHTML = '<option value="">Sin horarios disponibles</option>';
            help.textContent = 'No hay horarios disponibles para esa fecha (domingos u horarios ocupados).';
            return;
          }

          // Rellena el select con las horas disponibles
          horaSelect.innerHTML = '<option value="">Selecciona una hora</option>';
          slots.forEach(h => {
            const opt = document.createElement('option');
            opt.value = h;
            opt.textContent = h;
            horaSelect.appendChild(opt);
          });

          help.textContent = 'Solo se muestran horarios disponibles entre 12:00 y 17:00 (sin 14:00).';
        } catch (err) {
          console.error(err);
          horaSelect.innerHTML = '<option value="">Error al cargar horarios</option>';
          help.textContent = 'No se pudo consultar la disponibilidad. Intenta de nuevo.';
        }
      }

      // Cuando cambie la fecha, recargamos horas
      $('#fecha').addEventListener('change', cargarHorasDisponibles);

      // Opcional: si ya hay fecha al cargar, intenta cargar horas
      if ($('#fecha').value) {
        cargarHorasDisponibles();
      }

      function construirMensaje() {
        const nombre = $('#nombre').value.trim();
        const telefono = $('#telefono').value.trim();
        const fecha = $('#fecha').value;
        const hora = $('#hora').value; // viene del <select>
        const domicilioActual = $('#domicilioActual').value.trim();
        const domicilioNuevo = $('#domicilioNuevo').value.trim();
        const comentarios = $('#comentarios').value.trim();

        let msg = `Hola üëã\nMe gustar√≠a solicitar un *cambio de domicilio* de mi servicio.\n\n`;
        msg += `*Nombre:* ${nombre}\n`;
        msg += `*Tel√©fono de contacto:* ${telefono}\n`;
        msg += `*Domicilio actual:*\n${domicilioActual}\n`;
        msg += `*Nuevo domicilio:*\n${domicilioNuevo}\n`;
        msg += `*Fecha en la que me pueden recibir:* ${fecha || 'No especificada'}\n`;
        msg += `*Hora en la que me pueden recibir:* ${hora || 'No especificada'}\n`;
        if (comentarios) {
          msg += `*Comentarios adicionales:*\n${comentarios}\n`;
        }
        return msg;
      }

      function enviarWhatsApp() {
        if (!validarFormulario()) return;
        const mensaje = construirMensaje();
        const url = `https://api.whatsapp.com/send?phone=${NUMERO_DESTINO}&text=${encodeURIComponent(mensaje)}&type=phone_number&app_absent=0`;
        window.open(url, '_blank');
        toast('Abriendo WhatsApp‚Ä¶');
      }

      $('#form').addEventListener('submit', (e) => {
        e.preventDefault();
        enviarWhatsApp();
      });

      // Compartir app
      $('#shareBtn').addEventListener('click', async (e) => {
        e.preventDefault();
        if (navigator.share) {
          try {
            await navigator.share({
              title: 'Airconekta Cambio de domicilio',
              text: 'Formulario para solicitar cambio de domicilio de servicio',
              url: location.href
            });
          } catch (err) { /* cancelado */ }
        } else {
          navigator.clipboard?.writeText(location.href);
          toast('Enlace copiado');
        }
      });

      // PWA: manifest + service worker
      const manifest = {
        name: 'Airconekta Cambio',
        short_name: 'Cambio',
        description: 'Formulario PWA para solicitar cambio de domicilio del servicio y enviar datos por WhatsApp.',
        start_url: './cambio.html',
        display: 'standalone',
        background_color: '#ffffff',
        theme_color: '#ffffff',
        icons: [
          { src: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAQAAACENn8fAAAAI0lEQVQYV2NkYGD4z0AEMGGgAQZGBgYGBhA1FIwJQ3EAAEw4AABf1g4p2n3Y3wAAAABJRU5ErkJggg==', sizes: '48x48', type: 'image/png' },
          { src: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAQAAAB8Hs0fAAAAKUlEQVQ4y2NkoBAwUqifAWEGQwYGBgYwQ2oYg0EwGg0Go0GgYHxGAgA8m0g0pAKg5wAAAABJRU5ErkJggg==', sizes: '72x72', type: 'image/png' }
        ]
      };
      const manBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
      const manURL = URL.createObjectURL(manBlob);
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = manURL;
      document.head.appendChild(link);

      if ('serviceWorker' in navigator) {
        const swCode = `
          const CACHE = 'airconekta-cambio-v1';
          self.addEventListener('install', e => {
            e.waitUntil(caches.open(CACHE).then(c => c.addAll([self.registration.scope])));
            self.skipWaiting();
          });
          self.addEventListener('activate', e => { e.waitUntil(self.clients.claim()); });
          self.addEventListener('fetch', e => {
            const req = e.request;
            if (req.method !== 'GET') return;
            e.respondWith(
              caches.match(req).then(r => r || fetch(req).then(res => {
                const copy = res.clone();
                caches.open(CACHE).then(c => c.put(req, copy));
                return res;
              }).catch(() => caches.match(self.registration.scope)))
            );
          });
        `;
        const swBlob = new Blob([swCode], { type: 'text/javascript' });
        const swURL = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swURL).catch(() => {});
      }

      // Bot√≥n instalar PWA
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const btn = document.getElementById('installBtn');
        btn.style.display = 'inline-flex';
        btn.onclick = async () => {
          btn.disabled = true;
          try {
            await deferredPrompt.prompt();
            await deferredPrompt.userChoice;
          } finally {
            deferredPrompt = null;
            btn.style.display = 'none';
          }
        };
      });
    });
  </script>
</body>
</html>
