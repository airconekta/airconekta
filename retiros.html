<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Airconekta ¬∑ Retiros (3+)</title>

<!--
  ===========================================================
  Firma / Autor (solo visible al depurar o ver c√≥digo fuente)
  Jair Elizondo
  +52 322 243 9782
  Hint: /#whoami
  ===========================================================
-->

<style>
:root{
  --ink:#0f1a2e; --muted:#5b6b86; --accent:#246bff; --border:#cfe0ff;
  --card: rgba(255,255,255,.72);
  --shadow: 0 10px 26px rgba(16,48,96,.10);
}

body{margin:0;font:16px system-ui;background:#fff;color:var(--ink)}
.wrap{max-width:1200px;margin:auto;padding:20px}
.top{position:sticky;top:0;background:#fff;padding-bottom:10px;z-index:5}
input{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px}

table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border-bottom:1px solid #eef3ff;padding:10px;text-align:left;vertical-align:top}
th{
  color:var(--muted);
  user-select:none;
  white-space:nowrap;
  position:sticky; top:0; background:#fff; z-index:2;
}

/* ‚úÖ estilo "bot√≥n" clickeable */
th.sortable{
  cursor:pointer;
  touch-action:manipulation;
}
th.sortable:hover{
  color:var(--ink);
  background:rgba(36,107,255,.06);
}
th.sortable:active{
  background:rgba(36,107,255,.12);
}
th.sort-active{
  color:var(--ink);
  background:rgba(36,107,255,.06);
  border-bottom:2px solid rgba(36,107,255,.35);
}

th .arrow{
  font-size:.85em;
  margin-left:6px;
  opacity:.85;
}

button{
  border:1px solid var(--accent);background:#fff;color:var(--accent);
  padding:6px 10px;border-radius:10px;font-weight:800;cursor:pointer
}
button:disabled{opacity:.5}
.ok{color:#1f9d55;font-weight:800}
.muted{color:var(--muted)}

/* ========================= WHOAMI (solo con #whoami) ========================= */
[data-view]{ display:none; }
[data-view].active{ display:block; }

.who-shell{
  max-width:1100px;
  margin:0 auto;
  padding:20px;
}
.who-card{
  margin-top:12px;
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
  background:var(--card);
  box-shadow:var(--shadow);
}
.who-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}
.who-brand{
  display:flex;
  gap:12px;
  align-items:center;
}
.who-avatar{
  width:56px;height:56px;border-radius:16px;
  border:1px solid var(--border);
  display:grid;place-items:center;
  font-weight:1000;
  background:rgba(36,107,255,.08);
}
.who-title{ margin:0; font-size:1.25rem; }
.who-sub{ margin:4px 0 0; color:var(--muted); font-weight:700; }

.who-actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.who-btn{
  appearance:none;
  border:1px solid var(--border);
  background:#fff;
  color:var(--ink);
  padding:10px 12px;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.who-btn.primary{
  border-color: var(--accent);
  background: var(--accent);
  color:#fff;
}
.who-grid{
  display:grid;
  grid-template-columns:repeat(12,1fr);
  gap:12px;
  margin-top:12px;
}
.who-k{
  grid-column: span 6;
  border:1px solid #eef3ff;
  border-radius:14px;
  padding:12px;
  background:#fff;
}
.who-k strong{ display:block; margin-bottom:6px; }
@media(max-width:860px){
  .who-k{ grid-column: span 12; }
  .wrap{ padding:14px; }
  .who-shell{ padding:14px; }
}

.who-note{
  margin-top:12px;
  border:1px dashed var(--border);
  border-radius:14px;
  padding:12px;
  color:var(--muted);
  background:rgba(36,107,255,.05);
}

</style>
</head>

<body>

<!-- ===== VISTA NORMAL ===== -->
<div class="wrap" data-view="main" id="viewMain">
  <div class="top">
    <h2>üì° Airconekta ‚Äì Retiros (3+)</h2>
    <input id="q" placeholder="Buscar por direcci√≥n, barrio, tel√©fono, plan‚Ä¶">
    <div id="status" class="muted">Cargando‚Ä¶</div>
  </div>

  <table>
    <thead>
      <tr>
        <th class="sortable" data-col="Direcci√≥n">Direcci√≥n <span class="arrow" id="a-Direcci√≥n"></span></th>
        <th class="sortable" data-col="Barrio/Localidad">Barrio/Localidad <span class="arrow" id="a-Barrio/Localidad"></span></th>
        <th class="sortable" data-col="Plan Internet">Plan Internet <span class="arrow" id="a-Plan Internet"></span></th>
        <th class="sortable" data-col="Telefono">Telefono <span class="arrow" id="a-Telefono"></span></th>
        <th class="sortable" data-col="Plan Precio">Plan Precio <span class="arrow" id="a-Plan Precio"></span></th>
        <th class="sortable" data-col="Pagos Pendientes">Pagos Pendientes <span class="arrow" id="a-Pagos Pendientes"></span></th>
        <th class="sortable" data-col="Adeudos">Adeudos <span class="arrow" id="a-Adeudos"></span></th>
        <th class="sortable" data-col="Comentario">Comentario <span class="arrow" id="a-Comentario"></span></th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody id="tb"></tbody>
  </table>
</div>

<!-- ===== WHOAMI (solo con #whoami) ===== -->
<section class="who-shell" data-view="whoami" id="viewWhoami" aria-label="Whoami">
  <div class="who-card">
    <div class="who-top">
      <div class="who-brand">
        <div class="who-avatar" aria-hidden="true">JE</div>
        <div>
          <p class="who-title" id="whoName">Jair Elizondo</p>
          <p class="who-sub" id="whoRole">Soporte / Instalaciones ¬∑ Airconekta</p>
        </div>
      </div>

      <div class="who-actions">
        <a class="who-btn primary" id="whoWhatsBtn" href="#" rel="noopener noreferrer">üü¢ Abrir WhatsApp</a>
        <a class="who-btn" id="whoCallBtn" href="#">üìû Llamar</a>
        <button class="who-btn" type="button" id="whoCopyBtn">üìã Copiar</button>
        <button class="who-btn" type="button" id="whoBackBtn">‚Üê Volver</button>
      </div>
    </div>

    <div class="who-grid">
      <div class="who-k">
        <strong>üìû Tel√©fono</strong>
        <span id="whoPhonePretty">322 243 9782</span>
      </div>
      <div class="who-k">
        <strong>üîé Ruta</strong>
        <span class="muted">Se abre solo con <b>#whoami</b></span>
      </div>
      <div class="who-k">
        <strong>üß† Tip</strong>
        <span class="muted">Ver consola ‚Üí aparece firma (solo depuraci√≥n)</span>
      </div>
      <div class="who-k">
        <strong>üîí Nota</strong>
        <span class="muted">No se muestra en el dashboard normal</span>
      </div>
    </div>

    <div class="who-note">
      Si llegaste aqu√≠ por accidente: borra <b>#whoami</b> de la URL o presiona ‚ÄúVolver‚Äù.
    </div>
  </div>
</section>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzyys9F3FAGxnJEBCkYXOMH16xMFaouuThHahpa7rjzfTp-YTpY4J95U-n7v0f7l2U4/exec";
const API_KEY = "retiros2025x";

const tb = document.getElementById("tb");
const q  = document.getElementById("q");
const statusEl = document.getElementById("status");

let rows = [];
let rowsOriginal = [];
let sortState = { col: null, mode: 0 }; // 0 original, 1 asc, 2 desc

const norm = v => String(v ?? "").toLowerCase().trim();

function toNum(v){
  if (typeof v === "number") return v;
  const s = String(v ?? "");
  const nums = s.replace(/,/g,' ').match(/\d+(?:\.\d+)?/g);
  if(!nums || !nums.length) return 0;
  return parseFloat(nums[nums.length-1]) || 0;
}

async function load(){
  statusEl.textContent = "Cargando‚Ä¶";
  const r = await fetch(API_URL + "?key=" + encodeURIComponent(API_KEY));
  const j = await r.json();
  if(!j.ok) throw j;

  rows = (j.rows || []).map((x,i)=> ({...x, _origIndex:i}));
  rowsOriginal = rows.slice();

  sortState = { col:null, mode:0 };
  updateArrows();
  render();
}

function getFiltered(){
  const f = norm(q.value);
  if (!f) return rows.slice();
  return rows.filter(r =>
    norm(r["Direcci√≥n"]).includes(f) ||
    norm(r["Barrio/Localidad"]).includes(f) ||
    norm(r["Telefono"]).includes(f) ||
    norm(r["Plan Internet"]).includes(f) ||
    norm(r["Comentario"]).includes(f)
  );
}

function render(){
  const data = getFiltered();
  statusEl.textContent = `Mostrando ${data.length} de ${rows.length}`;

  tb.innerHTML = data.map(r=>{
    const c = String(r["Comentario"]||"").trim();
    const marked = c.length>0;
    return `
      <tr>
        <td>${r["Direcci√≥n"]||""}</td>
        <td>${r["Barrio/Localidad"]||""}</td>
        <td>${r["Plan Internet"]||""}</td>
        <td>${r["Telefono"]||""}</td>
        <td>${r["Plan Precio"]||""}</td>
        <td>${r["Pagos Pendientes"]||""}</td>
        <td><b>${r["Adeudos"]||""}</b></td>
        <td>${marked?`<span class="ok">${c}</span>`:`<span class="muted">‚Äî</span>`}</td>
        <td>
          <button ${marked?"disabled":""} onclick="mark(${r._row})">
            ${marked?"Listo":"RETIRADO"}
          </button>
        </td>
      </tr>
    `;
  }).join("");
}

function applySort(col, mode){
  if (mode === 0){
    rows = rowsOriginal.slice();
    return;
  }

  const numericCols = new Set(["Plan Precio","Pagos Pendientes","Adeudos"]);

  rows.sort((a,b)=>{
    let av = a[col], bv = b[col];

    if (numericCols.has(col)){
      av = toNum(av); bv = toNum(bv);
      return mode === 1 ? (av - bv) : (bv - av);
    }

    av = norm(av); bv = norm(bv);
    if (av < bv) return mode === 1 ? -1 : 1;
    if (av > bv) return mode === 1 ? 1 : -1;
    return a._origIndex - b._origIndex;
  });
}

function updateArrows(){
  document.querySelectorAll("th.sortable").forEach(th=>{
    th.classList.remove("sort-active");
    const col = th.getAttribute("data-col");
    const span = document.getElementById("a-" + col);
    if (span) span.textContent = "";
  });

  if (!sortState.col) return;

  const th = document.querySelector(`th.sortable[data-col="${CSS.escape(sortState.col)}"]`);
  if (th) th.classList.add("sort-active");

  const span = document.getElementById("a-" + sortState.col);
  if (!span) return;

  // 0 = original, 1 asc, 2 desc
  span.textContent = sortState.mode === 1 ? "‚ñ≤" : sortState.mode === 2 ? "‚ñº" : "‚Ü∫";
}

function cycleSort(col){
  if (sortState.col !== col){
    sortState = { col, mode: 1 };
  } else {
    sortState.mode = (sortState.mode === 1) ? 2 : (sortState.mode === 2) ? 0 : 1;
  }
  applySort(sortState.col, sortState.mode);
  updateArrows();
  render();
}

async function mark(row){
  if(!confirm("¬øMarcar como RETIRADO?")) return;
  await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({key:API_KEY,row,action:"RETIRADO"})
  });
  load();
}

q.addEventListener("input", render);

document.querySelectorAll("th.sortable").forEach(th=>{
  th.addEventListener("click", ()=>{
    const col = th.getAttribute("data-col");
    cycleSort(col);
  });
});

load().catch((e)=>{
  console.error(e);
  statusEl.textContent="ERROR: API_KEY o permisos";
});

/* =====================
   Firma + #whoami (NO toca tus funciones)
   ===================== */
const WHOAMI = {
  name: "Jair Elizondo",
  phonePretty: "322 243 9782",
  phoneDigits: "3222439782",
  role: "Soporte / Instalaciones ¬∑ Airconekta",
  hint: "#whoami",
  webHint: "Escribe #whoami al final de la URL"
};

(function consoleSignature(){
  try{
    const line = "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ";
    console.log("%c" + line, "color:#18c6ff;font-weight:900");
    console.log("%cAIRCONEKTA ¬∑ Firma de desarrollo", "color:#246bff;font-size:14px;font-weight:900");
    console.log("%c" + WHOAMI.name + "  ¬∑  " + WHOAMI.phonePretty + "  ¬∑  " + WHOAMI.hint, "color:#7c3aed;font-size:12px;font-weight:900");
    console.log("%c" + WHOAMI.webHint, "color:#5b6b86;font-size:12px;font-weight:800");
    console.log("%c" + line, "color:#18c6ff;font-weight:900");
  }catch{}
})();

function showView(name){
  const views = document.querySelectorAll("[data-view]");
  views.forEach(v => v.classList.remove("active"));
  const el = document.querySelector(`[data-view="${name}"]`);
  if (el) el.classList.add("active");
}

function renderWhoami(){
  const whoName = document.getElementById("whoName");
  const whoRole = document.getElementById("whoRole");
  const whoPhonePretty = document.getElementById("whoPhonePretty");
  const whoWhatsBtn = document.getElementById("whoWhatsBtn");
  const whoCallBtn = document.getElementById("whoCallBtn");
  const whoCopyBtn = document.getElementById("whoCopyBtn");
  const whoBackBtn = document.getElementById("whoBackBtn");

  if (whoName) whoName.textContent = WHOAMI.name;
  if (whoRole) whoRole.textContent = WHOAMI.role;
  if (whoPhonePretty) whoPhonePretty.textContent = WHOAMI.phonePretty;

  const waLink =
    `https://api.whatsapp.com/send?phone=52${WHOAMI.phoneDigits}` +
    `&text=${encodeURIComponent("Hola üëã " + WHOAMI.name + ", necesito soporte / info de Airconekta.")}` +
    `&type=phone_number&app_absent=0`;

  if (whoWhatsBtn) whoWhatsBtn.setAttribute("href", waLink);
  if (whoCallBtn) whoCallBtn.setAttribute("href", `tel:+52${WHOAMI.phoneDigits}`);

  if (whoCopyBtn) {
    whoCopyBtn.onclick = async () => {
      const text =
        `${WHOAMI.name}\n${WHOAMI.phonePretty}\nAirconekta\nTip: ${location.origin + location.pathname}#whoami`;
      try{
        await navigator.clipboard.writeText(text);
        alert("Datos copiados ‚úÖ");
      }catch{
        alert("No se pudo copiar (permiso del navegador)");
      }
    };
  }

  if (whoBackBtn) {
    whoBackBtn.onclick = () => {
      history.replaceState(null, "", location.pathname + location.search);
      showView("main");
    };
  }
}

function handleHashRoute(){
  const h = (location.hash || "").toLowerCase().trim();
  if (h === "#whoami"){
    renderWhoami();
    showView("whoami");
  } else {
    showView("main");
  }
}

window.addEventListener("hashchange", handleHashRoute, { passive:true });
handleHashRoute();
</script>

</body>
</html>
