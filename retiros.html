<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Airconekta Â· Retiros (3+)</title>

<style>
:root{
  --ink:#0f1a2e;--muted:#5b6b86;--accent:#246bff;--border:#cfe0ff;
}
body{margin:0;font:16px system-ui;background:#fff;color:var(--ink)}
.wrap{max-width:1200px;margin:auto;padding:20px}
.top{position:sticky;top:0;background:#fff;padding-bottom:10px}
input{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border-bottom:1px solid #eef3ff;padding:10px;text-align:left}
th{color:var(--muted)}
button{border:1px solid var(--accent);background:#fff;color:var(--accent);
padding:6px 10px;border-radius:10px;font-weight:800;cursor:pointer}
button:disabled{opacity:.5}
.ok{color:#1f9d55;font-weight:800}
.muted{color:var(--muted)}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <h2>ðŸ“¡ Airconekta â€“ Retiros (3+)</h2>
    <input id="q" placeholder="Buscar por direcciÃ³n, telÃ©fono, planâ€¦">
    <div id="status" class="muted">Cargandoâ€¦</div>
  </div>

  <table>
    <thead>
      <tr>
        <th>DirecciÃ³n</th>
        <th>Plan Internet</th>
        <th>Telefono</th>
        <th>Plan Precio</th>
        <th>Pagos Pendientes</th>
        <th>Adeudos</th>
        <th>Comentario</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="tb"></tbody>
  </table>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyM3gseJY88CK2Po7IEAnHHgPLqMS2fmi3txOFXExm3N5z8NV4b0m8N83aOM3EGOXFT/exec";
const API_KEY = "retiros2025x"; // âš ï¸ MISMA CLAVE QUE APPS SCRIPT

const tb = document.getElementById("tb");
const q  = document.getElementById("q");
const statusEl = document.getElementById("status");

let rows = [];

const norm = v => String(v ?? "").toLowerCase();

async function load(){
  statusEl.textContent = "Cargandoâ€¦";
  const r = await fetch(API_URL + "?key=" + API_KEY);
  const j = await r.json();
  if(!j.ok) throw j;
  rows = j.rows || [];
  render();
}

function render(){
  const f = norm(q.value);
  const data = !f ? rows : rows.filter(r =>
    norm(r["DirecciÃ³n"]).includes(f) ||
    norm(r["Telefono"]).includes(f) ||
    norm(r["Plan Internet"]).includes(f)
  );

  statusEl.textContent = `Mostrando ${data.length} de ${rows.length}`;

  tb.innerHTML = data.map(r=>{
    const c = String(r["Comentario"]||"").trim();
    const marked = c.length>0;

    return `
    <tr>
      <td>${r["DirecciÃ³n"]||""}</td>
      <td>${r["Plan Internet"]||""}</td>
      <td>${r["Telefono"]||""}</td>
      <td>${r["Plan Precio"]||""}</td>
      <td>${r["Pagos Pendientes"]||""}</td>
      <td><b>${r["Adeudos"]||""}</b></td>
      <td>${marked?`<span class="ok">${c}</span>`:`<span class="muted">â€”</span>`}</td>
      <td>
        <button ${marked?"disabled":""}
          onclick="mark(${r._row})">
          ${marked?"Listo":"RETIRADO"}
        </button>
      </td>
    </tr>`;
  }).join("");
}

async function mark(row){
  if(!confirm("Â¿Marcar como RETIRADO?")) return;
  await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({key:API_KEY,row,action:"RETIRADO"})
  });
  load();
}

q.addEventListener("input",render);
load().catch(()=>statusEl.textContent="ERROR: API_KEY o permisos");
</script>
</body>
</html>
