<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Airconekta Â· Retiros (3+)</title>

<style>
:root{
  --ink:#0f1a2e; --muted:#5b6b86; --accent:#246bff; --border:#cfe0ff;
}
body{margin:0;font:16px system-ui;background:#fff;color:var(--ink)}
.wrap{max-width:1200px;margin:auto;padding:20px}
.top{position:sticky;top:0;background:#fff;padding-bottom:10px;z-index:5}
input{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px}

table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border-bottom:1px solid #eef3ff;padding:10px;text-align:left;vertical-align:top}
th{
  color:var(--muted);
  user-select:none;
  white-space:nowrap;
  position:sticky; top:0; background:#fff; z-index:2;
}

/* âœ… estilo "botÃ³n" clickeable */
th.sortable{
  cursor:pointer;
  touch-action:manipulation;
}
th.sortable:hover{
  color:var(--ink);
  background:rgba(36,107,255,.06);
}
th.sortable:active{
  background:rgba(36,107,255,.12);
}
th.sort-active{
  color:var(--ink);
  background:rgba(36,107,255,.06);
  border-bottom:2px solid rgba(36,107,255,.35);
}

th .arrow{
  font-size:.85em;
  margin-left:6px;
  opacity:.85;
}

button{
  border:1px solid var(--accent);background:#fff;color:var(--accent);
  padding:6px 10px;border-radius:10px;font-weight:800;cursor:pointer
}
button:disabled{opacity:.5}
.ok{color:#1f9d55;font-weight:800}
.muted{color:var(--muted)}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <h2>ðŸ“¡ Airconekta â€“ Retiros (3+)</h2>
    <input id="q" placeholder="Buscar por direcciÃ³n, barrio, telÃ©fono, planâ€¦">
    <div id="status" class="muted">Cargandoâ€¦</div>
  </div>

  <table>
    <thead>
      <tr>
        <th class="sortable" data-col="DirecciÃ³n">DirecciÃ³n <span class="arrow" id="a-DirecciÃ³n"></span></th>
        <th class="sortable" data-col="Barrio/Localidad">Barrio/Localidad <span class="arrow" id="a-Barrio/Localidad"></span></th>
        <th class="sortable" data-col="Plan Internet">Plan Internet <span class="arrow" id="a-Plan Internet"></span></th>
        <th class="sortable" data-col="Telefono">Telefono <span class="arrow" id="a-Telefono"></span></th>
        <th class="sortable" data-col="Plan Precio">Plan Precio <span class="arrow" id="a-Plan Precio"></span></th>
        <th class="sortable" data-col="Pagos Pendientes">Pagos Pendientes <span class="arrow" id="a-Pagos Pendientes"></span></th>
        <th class="sortable" data-col="Adeudos">Adeudos <span class="arrow" id="a-Adeudos"></span></th>
        <th class="sortable" data-col="Comentario">Comentario <span class="arrow" id="a-Comentario"></span></th>
        <th>AcciÃ³n</th>
      </tr>
    </thead>
    <tbody id="tb"></tbody>
  </table>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzyys9F3FAGxnJEBCkYXOMH16xMFaouuThHahpa7rjzfTp-YTpY4J95U-n7v0f7l2U4/exec";
const API_KEY = "retiros2025x";

const tb = document.getElementById("tb");
const q  = document.getElementById("q");
const statusEl = document.getElementById("status");

let rows = [];
let rowsOriginal = [];
let sortState = { col: null, mode: 0 }; // 0 original, 1 asc, 2 desc

const norm = v => String(v ?? "").toLowerCase().trim();

function toNum(v){
  if (typeof v === "number") return v;
  const s = String(v ?? "");
  const nums = s.replace(/,/g,' ').match(/\d+(?:\.\d+)?/g);
  if(!nums || !nums.length) return 0;
  return parseFloat(nums[nums.length-1]) || 0;
}

async function load(){
  statusEl.textContent = "Cargandoâ€¦";
  const r = await fetch(API_URL + "?key=" + encodeURIComponent(API_KEY));
  const j = await r.json();
  if(!j.ok) throw j;

  rows = (j.rows || []).map((x,i)=> ({...x, _origIndex:i}));
  rowsOriginal = rows.slice();

  sortState = { col:null, mode:0 };
  updateArrows();
  render();
}

function getFiltered(){
  const f = norm(q.value);
  if (!f) return rows.slice();
  return rows.filter(r =>
    norm(r["DirecciÃ³n"]).includes(f) ||
    norm(r["Barrio/Localidad"]).includes(f) ||
    norm(r["Telefono"]).includes(f) ||
    norm(r["Plan Internet"]).includes(f) ||
    norm(r["Comentario"]).includes(f)
  );
}

function render(){
  const data = getFiltered();
  statusEl.textContent = `Mostrando ${data.length} de ${rows.length}`;

  tb.innerHTML = data.map(r=>{
    const c = String(r["Comentario"]||"").trim();
    const marked = c.length>0;
    return `
      <tr>
        <td>${r["DirecciÃ³n"]||""}</td>
        <td>${r["Barrio/Localidad"]||""}</td>
        <td>${r["Plan Internet"]||""}</td>
        <td>${r["Telefono"]||""}</td>
        <td>${r["Plan Precio"]||""}</td>
        <td>${r["Pagos Pendientes"]||""}</td>
        <td><b>${r["Adeudos"]||""}</b></td>
        <td>${marked?`<span class="ok">${c}</span>`:`<span class="muted">â€”</span>`}</td>
        <td>
          <button ${marked?"disabled":""} onclick="mark(${r._row})">
            ${marked?"Listo":"RETIRADO"}
          </button>
        </td>
      </tr>
    `;
  }).join("");
}

function applySort(col, mode){
  if (mode === 0){
    rows = rowsOriginal.slice();
    return;
  }

  const numericCols = new Set(["Plan Precio","Pagos Pendientes","Adeudos"]);

  rows.sort((a,b)=>{
    let av = a[col], bv = b[col];

    if (numericCols.has(col)){
      av = toNum(av); bv = toNum(bv);
      return mode === 1 ? (av - bv) : (bv - av);
    }

    av = norm(av); bv = norm(bv);
    if (av < bv) return mode === 1 ? -1 : 1;
    if (av > bv) return mode === 1 ? 1 : -1;
    return a._origIndex - b._origIndex;
  });
}

function updateArrows(){
  document.querySelectorAll("th.sortable").forEach(th=>{
    th.classList.remove("sort-active");
    const col = th.getAttribute("data-col");
    const span = document.getElementById("a-" + col);
    if (span) span.textContent = "";
  });

  if (!sortState.col) return;

  const th = document.querySelector(`th.sortable[data-col="${CSS.escape(sortState.col)}"]`);
  if (th) th.classList.add("sort-active");

  const span = document.getElementById("a-" + sortState.col);
  if (!span) return;

  // 0 = original, 1 asc, 2 desc
  span.textContent = sortState.mode === 1 ? "â–²" : sortState.mode === 2 ? "â–¼" : "â†º";
}

function cycleSort(col){
  if (sortState.col !== col){
    sortState = { col, mode: 1 };
  } else {
    sortState.mode = (sortState.mode === 1) ? 2 : (sortState.mode === 2) ? 0 : 1;
  }
  applySort(sortState.col, sortState.mode);
  updateArrows();
  render();

  // âœ… si quieres confirmar clicks, descomenta:
  // console.log("sort:", sortState.col, sortState.mode);
}

async function mark(row){
  if(!confirm("Â¿Marcar como RETIRADO?")) return;
  await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({key:API_KEY,row,action:"RETIRADO"})
  });
  load();
}

q.addEventListener("input", render);

document.querySelectorAll("th.sortable").forEach(th=>{
  th.addEventListener("click", ()=>{
    const col = th.getAttribute("data-col");
    cycleSort(col);
  });
});

load().catch((e)=>{
  console.error(e);
  statusEl.textContent="ERROR: API_KEY o permisos";
});
</script>
</body>
</html>
