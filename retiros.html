<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Airconekta ¬∑ Retiros (3+)</title>

<!--
  ===========================================================
  Firma / Autor (solo visible al depurar o ver c√≥digo fuente)
  Jair Elizondo
  +52 322 243 9782
  Hint: /#whoami
  ===========================================================
-->

<style>
:root{
  --ink:#0f1a2e; --muted:#5b6b86; --accent:#246bff; --border:#cfe0ff;
  --ring: 0 0 0 4px rgba(36,107,255,.16);
  --glass: rgba(255,255,255,.92);
}
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{margin:0;font:16px system-ui;background:#fff;color:var(--ink)}
.wrap{max-width:1200px;margin:auto;padding:20px}
.top{position:sticky;top:0;background:#fff;padding-bottom:10px;z-index:5}
input{width:100%;padding:12px;border:1px solid var(--border);border-radius:14px}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border-bottom:1px solid #eef3ff;padding:10px;text-align:left;vertical-align:top}
th{color:var(--muted);user-select:none;white-space:nowrap;position:sticky;top:0;background:#fff;z-index:2}
th.sortable{ cursor:pointer; touch-action:manipulation; }
th.sortable:hover{ color:var(--ink); background:rgba(36,107,255,.06); }
th.sortable:active{ background:rgba(36,107,255,.12); }
th.sort-active{ color:var(--ink); background:rgba(36,107,255,.06); border-bottom:2px solid rgba(36,107,255,.35); }
th .arrow{ font-size:.85em; margin-left:6px; opacity:.85; }

button{
  border:1px solid rgba(36,107,255,.55);
  background:#fff;
  color:var(--ink);
  padding:9px 12px;
  border-radius:14px;
  font-weight:950;
  cursor:pointer
}
button:hover{ box-shadow: var(--ring); border-color: rgba(36,107,255,.9); }
button:disabled{opacity:.55; cursor:not-allowed; box-shadow:none}
.btn-primary{ border:0; color:#fff; background: linear-gradient(135deg, var(--accent), #18c6ff); }
.ok{color:#1f9d55;font-weight:950}
.muted{color:var(--muted);font-weight:850}

/* Top controls row */
.controls-row{
  display:flex; gap:10px; align-items:center; justify-content:space-between;
  flex-wrap:wrap; margin-top:10px;
}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 12px; border-radius:999px;
  border:1px solid rgba(36,107,255,.18);
  background: rgba(36,107,255,.06);
  font-weight:950;
}
.badge small{ color:var(--muted); font-weight:900; }

/* Column picker */
body.cols-open{ overflow:hidden; }
.cols-backdrop{
  position:fixed; inset:0;
  background: rgba(7,11,20,.55);
  backdrop-filter: blur(8px) saturate(120%);
  display:none; z-index:9997;
}
.cols-backdrop.show{ display:block; }
.cols-sheet{
  position:fixed; left:0; right:0; bottom:0;
  height:min(78vh,740px);
  background: var(--glass);
  border-top-left-radius:24px; border-top-right-radius:24px;
  box-shadow:0 -24px 90px rgba(0,0,0,.35);
  transform: translateY(110%);
  transition: transform .22s ease;
  z-index:9998;
  display:flex; flex-direction:column;
  overflow:hidden;
  border:1px solid rgba(207,224,255,.65);
}
.cols-sheet.show{ transform: translateY(0); }
@media (min-width:980px){
  .cols-sheet{
    left:auto; right:18px; bottom:18px;
    width:520px; height:min(78vh,760px);
    border-radius:24px;
    box-shadow:0 30px 90px rgba(0,0,0,.35);
    transform: translateX(120%);
  }
  .cols-sheet.show{ transform: translateX(0); }
}
.cols-topbar{
  padding:14px 14px 12px;
  border-bottom:1px solid rgba(207,224,255,.7);
  background:
    radial-gradient(700px 240px at 10% 0%, rgba(36,107,255,.18), transparent 55%),
    radial-gradient(700px 240px at 90% 0%, rgba(24,198,255,.14), transparent 55%),
    #fff;
}
.cols-title{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.cols-title h3{ margin:0; font-size:1.05rem; font-weight:1000; }
.cols-close{
  border:1px solid rgba(36,107,255,.35);
  background:#fff; color:var(--ink);
  border-radius:14px; padding:10px 12px; font-weight:1000;
}
.cols-close:hover{ box-shadow: var(--ring); }
.cols-subrow{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:10px; flex-wrap:wrap; }
.cols-count{ font-weight:1000; color:var(--muted); }
.cols-actions{ display:flex; gap:8px; flex-wrap:wrap; }
.cols-actions button{
  padding:8px 10px; border-radius:999px;
  border:1px solid rgba(36,107,255,.22);
  background: rgba(36,107,255,.06);
}
.cols-actions button:hover{ box-shadow: var(--ring); border-color: rgba(36,107,255,.55); }
.cols-search{ margin-top:10px; display:flex; gap:10px; }
.cols-search input{
  padding:12px 12px; border-radius:14px;
  border:1px solid rgba(207,224,255,.9);
  background: rgba(255,255,255,.92);
}
.note{
  padding:10px 12px; border-radius:16px;
  border:1px dashed rgba(207,224,255,.95);
  background: rgba(247,251,255,.92);
  color:var(--muted); font-weight:900;
  margin-top:10px;
}
.cols-body{ padding:12px 14px 14px; overflow:auto; }
.cols-grid{ display:grid; grid-template-columns:1fr; gap:10px; }
@media (min-width:640px){ .cols-grid{ grid-template-columns:1fr 1fr; } }
.col-item{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:12px 12px; border-radius:16px;
  border:1px solid rgba(207,224,255,.75);
  background: rgba(255,255,255,.85);
}
.col-item:hover{ box-shadow: 0 10px 26px rgba(16,48,96,.10); }
.col-name{ font-weight:1000; color:var(--ink); line-height:1.15; word-break:break-word; }
.col-meta{ font-size:.85rem; color:var(--muted); font-weight:900; }

.switch{ position:relative; width:52px; height:30px; flex:0 0 auto; }
.switch input{ display:none; }
.slider{
  position:absolute; inset:0;
  background: rgba(91,107,134,.22);
  border:1px solid rgba(207,224,255,.9);
  border-radius:999px;
  transition: .16s ease;
}
.slider:before{
  content:"";
  position:absolute;
  width:24px; height:24px;
  left:3px; top:2px;
  background:#fff;
  border-radius:999px;
  box-shadow: 0 10px 20px rgba(0,0,0,.15);
  transition: .16s ease;
}
.switch input:checked + .slider{
  background: linear-gradient(135deg, var(--accent), #18c6ff);
  border-color: rgba(36,107,255,.35);
}
.switch input:checked + .slider:before{ transform: translateX(22px); }

/* ========================= Splash Screen (Airconekta) ========================= */
.splash{
  position:fixed;
  inset:0;
  display:grid;
  place-items:center;
  background:
    radial-gradient(900px 520px at 20% 15%, rgba(36,107,255,.28), transparent 60%),
    radial-gradient(900px 520px at 85% 25%, rgba(24,198,255,.22), transparent 55%),
    radial-gradient(900px 520px at 45% 100%, rgba(124,58,237,.18), transparent 60%),
    linear-gradient(180deg, #070b14, #0b1220);
  z-index:9999;
  transition: opacity .35s ease, transform .35s ease, visibility .35s ease;
}
.splash.hide{
  opacity:0;
  transform: translateY(-6px);
  visibility:hidden;
  pointer-events:none;
}
.splash-card{
  width:min(92vw, 520px);
  border-radius: 28px;
  padding: 26px 20px;
  text-align:center;
  color:#eaf2ff;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(10,16,30,.55);
  box-shadow: 0 30px 90px rgba(0,0,0,.6);
  backdrop-filter: blur(14px) saturate(120%);
}
.splash-logo{
  width: 84px;
  height: 84px;
  margin: 0 auto 10px;
  border-radius: 26px;
  display:grid;
  place-items:center;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  position:relative;
  overflow:hidden;
}
.splash-logo::before{
  content:"";
  position:absolute;
  inset:-40%;
  background: conic-gradient(
    from 0deg,
    rgba(36,107,255,.0),
    rgba(36,107,255,.6),
    rgba(24,198,255,.55),
    rgba(124,58,237,.55),
    rgba(36,107,255,.0)
  );
  animation: spin 2.4s linear infinite;
  opacity:.9;
}
.splash-logo .logo-img{
  position:relative;
  width: 58px;
  height: 58px;
  border-radius: 22px;
  display:block;
  background: rgba(11,18,32,.92);
  border:1px solid rgba(255,255,255,.12);
  object-fit: contain;
  padding: 10px;
}
.splash-title{
  font-weight: 1000;
  letter-spacing: .6px;
  font-size: clamp(1.7rem, 4vw, 2.4rem);
  margin: 8px 0 6px;
}
.splash-sub{
  margin: 0;
  color: rgba(233,238,252,.78);
  font-weight: 800;
}
.splash-bar{
  height: 10px;
  margin: 16px auto 0;
  border-radius: 999px;
  width: min(360px, 82%);
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.10);
  overflow:hidden;
}
.splash-bar > i{
  display:block;
  height:100%;
  width: 40%;
  background: linear-gradient(90deg, rgba(36,107,255,.15), rgba(36,107,255,.85), rgba(24,198,255,.85));
  border-radius: 999px;
  animation: load 1.1s ease-in-out infinite;
  filter: drop-shadow(0 6px 14px rgba(36,107,255,.20));
}
@keyframes load{
  0%{ transform: translateX(-30%); opacity:.65; }
  50%{ transform: translateX(120%); opacity:1; }
  100%{ transform: translateX(260%); opacity:.65; }
}
@keyframes spin{ to{ transform: rotate(360deg);} }
@media (prefers-reduced-motion: reduce){
  .splash-logo::before, .splash-bar > i{ animation:none !important; }
  .splash{ transition:none; }
}
.sr-only{
  position:absolute;
  width:1px;
  height:1px;
  padding:0;
  margin:-1px;
  overflow:hidden;
  clip:rect(0,0,0,0);
  border:0;
}

/* ========================= WHOAMI (vista especial) ========================= */
[data-view]{ display:none; }
[data-view].active{ display:block; }

.card{
  border:1px solid var(--border);
  border-radius: 22px;
  padding:16px;
  background: rgba(255,255,255,.92);
  box-shadow: 0 12px 30px rgba(16,48,96,.08);
}

.top-actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}

.divider{ height:1px; background:#eef3ff; margin:14px 0; }

.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-size:.9rem;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background: rgba(36,107,255,.06);
  color:var(--muted);
  font-weight:900;
}

.who-wrap{
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap:14px;
  margin-top:12px;
  align-items:stretch;
}
@media (max-width:860px){
  .who-wrap{ grid-template-columns:1fr; }
}
.who-card{
  border:1px solid var(--border);
  border-radius: 22px;
  padding:16px;
  background: rgba(255,255,255,.92);
  box-shadow: 0 12px 30px rgba(16,48,96,.08);
}
.who-hero{
  display:flex;
  gap:14px;
  align-items:center;
  flex-wrap:wrap;
}
.who-avatar{
  width:72px;
  height:72px;
  border-radius: 22px;
  border:1px solid var(--border);
  background:
    radial-gradient(60px 60px at 30% 20%, rgba(36,107,255,.22), transparent 60%),
    radial-gradient(60px 60px at 90% 30%, rgba(24,198,255,.16), transparent 55%),
    radial-gradient(60px 60px at 40% 95%, rgba(124,58,237,.14), transparent 60%),
    rgba(255,255,255,.92);
  display:grid;
  place-items:center;
  font-weight:1000;
  letter-spacing:.6px;
}
.who-name{ font-size:1.25rem; margin:0; font-weight:1000; }
.who-role{ margin:2px 0 0; color:var(--muted); font-weight:900; }

.kpoints{
  display:grid;
  grid-template-columns:repeat(12,1fr);
  gap:10px;
  margin-top:10px;
}
.k{
  grid-column:span 6;
  border:1px solid #eef3ff;
  border-radius: 18px;
  padding:12px;
  background: rgba(247,251,255,.92);
}
.k strong{ display:block; margin-bottom:4px; font-weight:1000; }
@media (max-width:860px){ .k{ grid-column:span 12; } }

.who-actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:12px;
}
.who-actions a{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 14px;
  border-radius:14px;
  text-decoration:none;
  font-weight:950;
  border:1px solid rgba(36,107,255,.55);
  color:var(--ink);
  background:#fff;
}
.who-actions a:hover{ box-shadow: var(--ring); border-color: rgba(36,107,255,.9); }
.who-actions a.btn-primary{
  border:0;
  color:#fff;
  background: linear-gradient(135deg, var(--accent), #18c6ff);
}
.who-actions a.btn-primary:hover{ box-shadow: var(--ring); }
</style>
</head>

<body>

<!-- Splash -->
<div class="splash" id="splash" aria-label="Cargando Airconekta">
  <div class="splash-card" role="status" aria-live="polite">
    <div class="splash-logo" aria-hidden="true">
      <img class="logo-img" alt=""
        src="https://raw.githubusercontent.com/airconekta/airconekta/refs/heads/main/airconekta_logo_transparent.png" />
    </div>
    <div class="splash-title">AIRCONEKTA</div>
    <p class="splash-sub">Retiros (3+) ¬∑ Panel interno</p>
    <div class="splash-bar" aria-hidden="true"><i></i></div>
    <p class="sr-only">Cargando‚Ä¶</p>
  </div>
</div>

<!-- =====================
     VISTAS
===================== -->

<!-- Vista normal: panel -->
<section data-view="panel" id="viewPanel" class="active">
  <div class="cols-backdrop" id="colsBackdrop" aria-hidden="true"></div>

  <div class="cols-sheet" id="colsSheet" role="dialog" aria-modal="true" aria-label="Columnas">
    <div class="cols-topbar">
      <div class="cols-title">
        <h3>Columnas extra</h3>
        <button class="cols-close" type="button" id="colsCloseBtn">‚úï</button>
      </div>

      <div class="cols-subrow">
        <div class="cols-count" id="colsCount">Extras visibles: 0</div>
        <div class="cols-actions">
          <button type="button" id="colsAllBtn">Todo</button>
          <button type="button" id="colsNoneBtn">Nada</button>
          <button type="button" id="colsResetBtn">Restaurar</button>
        </div>
      </div>

      <div class="cols-search">
        <input id="colsSearch" placeholder="Buscar columna (IP, Router, SN ONU, Coordenadas)‚Ä¶" />
      </div>

      <div class="note">
        Cambia al instante: al activar/desactivar una columna se muestra/oculta inmediatamente ‚úÖ
      </div>
    </div>

    <div class="cols-body">
      <div class="cols-grid" id="colsGrid"></div>
    </div>
  </div>

  <div class="wrap">
    <div class="top">
      <h2>üì° Airconekta ‚Äì Retiros (3+)</h2>
      <input id="q" placeholder="Buscar por direcci√≥n, barrio, tel√©fono, plan‚Ä¶">

      <div class="controls-row">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button class="btn-primary" type="button" id="openColsBtn">‚öôÔ∏è Columnas</button>
          <span class="badge">üìå Fijas <small>+ extras</small></span>
        </div>
        <div id="status" class="muted">Cargando‚Ä¶</div>
      </div>
    </div>

    <table>
      <thead>
        <tr id="theadRow"></tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>
</section>

<!-- ===== WHOAMI (vista oculta por hash) ===== -->
<section class="wrap" data-view="whoami" id="viewWhoami" aria-label="Whoami">
  <div class="card">
    <div class="top-actions">
      <div>
        <h2 style="margin:0">Whoami</h2>
        <div class="muted" style="margin-top:4px">Vista especial (solo con <b>#whoami</b>).</div>
      </div>
      <button class="cols-close" type="button" id="whoBackBtn">‚Üê Volver</button>
    </div>

    <div class="who-wrap">
      <div class="who-card">
        <div class="who-hero">
          <div class="who-avatar" aria-hidden="true">JE</div>
          <div>
            <p class="who-name" id="whoName">‚Äî</p>
            <p class="who-role" id="whoRole">‚Äî</p>
          </div>
          <span class="pill">üß© Debug route ¬∑ #whoami</span>
        </div>

        <div class="divider"></div>

        <div class="kpoints">
          <div class="k">
            <strong>üìû Tel√©fono</strong>
            <span class="muted" id="whoPhonePretty">‚Äî</span>
          </div>
          <div class="k">
            <strong>üü¢ WhatsApp</strong>
            <span class="muted">Toca ‚ÄúAbrir chat‚Äù para escribir directo</span>
          </div>
          <div class="k">
            <strong>üß† Tip</strong>
            <span class="muted">En consola tambi√©n aparece tu firma</span>
          </div>
          <div class="k">
            <strong>üîí Nota</strong>
            <span class="muted">No aparece en el panel normal, solo aqu√≠</span>
          </div>
        </div>

        <div class="who-actions">
          <a class="btn-primary" id="whoWhatsBtn" href="#" rel="noopener noreferrer">üü¢ Abrir chat</a>
          <a id="whoCallBtn" href="#">üìû Llamar</a>
          <button type="button" id="whoCopyBtn">üìã Copiar datos</button>
        </div>

        <div class="divider"></div>

        <div class="note" style="margin-top:0">
          Si llegaste aqu√≠ por accidente: vuelve al panel o borra el hash (<b>#whoami</b>) de la URL.
        </div>
      </div>

      <div class="who-card">
        <h3 style="margin:0 0 8px">üîé ¬øC√≥mo s√© que s√≠ funciona?</h3>
        <div class="note" style="margin-top:0">
          <b>1)</b> Abre DevTools ‚Üí Console y recarga: ver√°s tu firma.<br><br>
          <b>2)</b> Ver c√≥digo fuente: ver√°s el bloque de firma en comentarios.<br><br>
          <b>3)</b> Escribe <b>#whoami</b> al final de la URL: te trae a esta vista.
        </div>
      </div>
    </div>
  </div>
</section>

<script>
/* =====================
   CONFIG
===================== */
const API_URL = "https://script.google.com/macros/s/AKfycbz47QCct_OgtFPRm9ucdwNQkuJRHWj2JEXmOSHppYm7X0zC0gEXqozErQSJl5K0jMVV/exec";
const API_KEY = "retiros2025x";

/* =====================
   WHOAMI + FIRMA
===================== */
const WHOAMI = {
  name: "Jair Elizondo",
  phonePretty: "322 243 9782",
  phoneDigits: "3222439782",
  role: "Soporte / Instalaciones ¬∑ Airconekta",
  hint: "#whoami",
  webHint: "Escribe #whoami al final de la URL"
};

(function consoleSignature(){
  try{
    const line = "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ";
    console.log("%c" + line, "color:#18c6ff;font-weight:900");
    console.log("%cAIRCONEKTA ¬∑ Firma de desarrollo","color:#246bff;font-size:14px;font-weight:900");
    console.log("%c" + WHOAMI.name + "  ¬∑  " + WHOAMI.phonePretty + "  ¬∑  " + WHOAMI.hint,"color:#7c3aed;font-size:12px;font-weight:900");
    console.log("%c" + WHOAMI.webHint, "color:#5b6b86;font-size:12px;font-weight:800");
    console.log("%c" + line, "color:#18c6ff;font-weight:900");
  }catch{}
})();

/* =====================
   Splash
===================== */
const splash = document.getElementById("splash");
const hideSplash = () => splash?.classList.add("hide");
splash?.addEventListener("click", hideSplash, { passive:true });
window.addEventListener("load", ()=> setTimeout(hideSplash, 3000));

/* =====================
   Router de vistas (#whoami) ‚Äî OCULTO
===================== */
const viewPanel  = document.getElementById("viewPanel");
const viewWhoami = document.getElementById("viewWhoami");

function showView(name){
  viewPanel.classList.toggle("active", name === "panel");
  viewWhoami.classList.toggle("active", name === "whoami");
}

function renderWhoami(){
  document.getElementById("whoName").textContent = WHOAMI.name;
  document.getElementById("whoRole").textContent = WHOAMI.role;
  document.getElementById("whoPhonePretty").textContent = WHOAMI.phonePretty;

  const waLink =
    `https://api.whatsapp.com/send?phone=52${WHOAMI.phoneDigits}` +
    `&text=${encodeURIComponent("Hola üëã " + WHOAMI.name + ", necesito soporte / info de Airconekta.")}` +
    `&type=phone_number&app_absent=0`;

  document.getElementById("whoWhatsBtn").setAttribute("href", waLink);
  document.getElementById("whoCallBtn").setAttribute("href", `tel:+52${WHOAMI.phoneDigits}`);

  document.getElementById("whoCopyBtn").onclick = async () => {
    const text =
      `${WHOAMI.name}\n` +
      `${WHOAMI.phonePretty}\n` +
      `Airconekta\n` +
      `Tip: ${location.origin + location.pathname}#whoami`;

    try{
      await navigator.clipboard.writeText(text);
      alert("Datos copiados ‚úÖ");
    }catch{
      alert("No se pudo copiar (permiso del navegador)");
    }
  };

  document.getElementById("whoBackBtn").onclick = () => {
    history.replaceState(null, "", location.pathname + location.search);
    showView("panel");
  };
}

function handleHashRoute(){
  const h = (location.hash || "").toLowerCase().trim();
  if (h === "#whoami"){
    renderWhoami();
    showView("whoami");
    return;
  }
  showView("panel");
}

window.addEventListener("hashchange", handleHashRoute, { passive:true });

/* =====================
   Helpers IP -> link (HTTP)
===================== */
function isIPv4(s){
  const v = String(s ?? "").trim();
  if (!/^\d{1,3}(\.\d{1,3}){3}$/.test(v)) return false;
  return v.split(".").every(o => {
    const n = Number(o);
    return Number.isInteger(n) && n >= 0 && n <= 255;
  });
}

/* =====================
   TABLA / DATOS
===================== */
const tb = document.getElementById("tb");
const q  = document.getElementById("q");
const statusEl = document.getElementById("status");
const theadRow = document.getElementById("theadRow");

let rows = [];
let rowsOriginal = [];
let sortState = { col: null, mode: 0 };

const norm = v => String(v ?? "").toLowerCase().trim();
const hasRetirado = (txt) => /retirad[oa]/i.test(String(txt || ""));

function toNum(v){
  if (typeof v === "number") return v;
  const s = String(v ?? "");
  const nums = s.replace(/,/g,' ').match(/\d+(?:\.\d+)?/g);
  if(!nums || !nums.length) return 0;
  return parseFloat(nums[nums.length-1]) || 0;
}

/* =====================
   Columnas
===================== */
const ALWAYS_COLS = [
  "Direcci√≥n",
  "Barrio/Localidad",
  "Plan Internet",
  "Telefono",
  "Plan Precio",
  "Pagos Pendientes",
  "Adeudos",
  "Comentario"
];

const STORAGE_KEY = "airconekta_retiros_cols_instant_v1";
let EXTRA_COLS = [];
let visibleCols = ALWAYS_COLS.slice();

function loadColsPrefs(){
  try{
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
    if (Array.isArray(saved) && saved.length) visibleCols = saved;
  }catch{}
  ALWAYS_COLS.forEach(c=>{
    if (!visibleCols.includes(c)) visibleCols.unshift(c);
  });
  visibleCols = visibleCols.filter((c,i,a)=>a.indexOf(c)===i);
}
function saveColsPrefs(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(visibleCols)); }catch{}
}
function extrasVisibleCount(){
  return visibleCols.filter(c => !ALWAYS_COLS.includes(c)).length;
}

/* =====================
   Column Picker UI
===================== */
const openColsBtn  = document.getElementById("openColsBtn");
const colsBackdrop = document.getElementById("colsBackdrop");
const colsSheet    = document.getElementById("colsSheet");
const colsCloseBtn = document.getElementById("colsCloseBtn");
const colsAllBtn   = document.getElementById("colsAllBtn");
const colsNoneBtn  = document.getElementById("colsNoneBtn");
const colsResetBtn = document.getElementById("colsResetBtn");
const colsGrid     = document.getElementById("colsGrid");
const colsSearch   = document.getElementById("colsSearch");
const colsCount    = document.getElementById("colsCount");

function openCols(){
  colsSearch.value = "";
  renderColsGrid();
  updateColsCount();
  document.body.classList.add("cols-open");
  colsBackdrop.classList.add("show");
  colsSheet.classList.add("show");
  colsBackdrop.setAttribute("aria-hidden","false");
}
function closeCols(){
  document.body.classList.remove("cols-open");
  colsBackdrop.classList.remove("show");
  colsSheet.classList.remove("show");
  colsBackdrop.setAttribute("aria-hidden","true");
}
function updateColsCount(){
  colsCount.textContent = `Extras visibles: ${extrasVisibleCount()}`;
}

function renderColsGrid(){
  const term = norm(colsSearch.value);

  const extras = EXTRA_COLS.slice()
    .filter(c => c && !ALWAYS_COLS.includes(c))
    .filter(c => !term || norm(c).includes(term))
    .sort((a,b)=> a.localeCompare(b,"es"));

  if (!extras.length){
    colsGrid.innerHTML = `
      <div class="muted" style="font-weight:1000">
        No hay columnas extra.
      </div>
    `;
    return;
  }

  colsGrid.innerHTML = extras.map(col=>{
    const on = visibleCols.includes(col);
    return `
      <div class="col-item">
        <div>
          <div class="col-name">${col}</div>
          <div class="col-meta">${on ? "Visible" : "Oculta"}</div>
        </div>
        <label class="switch" title="${on ? "Ocultar" : "Mostrar"}">
          <input type="checkbox" data-col="${String(col).replace(/"/g,'&quot;')}" ${on ? "checked":""}>
          <span class="slider"></span>
        </label>
      </div>
    `;
  }).join("");

  colsGrid.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
    chk.addEventListener("change", ()=>{
      const col = chk.getAttribute("data-col");

      if (chk.checked){
        if (!visibleCols.includes(col)) visibleCols.push(col);
      } else {
        visibleCols = visibleCols.filter(c => c !== col);
      }

      ALWAYS_COLS.forEach(c=>{
        if (!visibleCols.includes(c)) visibleCols.unshift(c);
      });
      visibleCols = visibleCols.filter((c,i,a)=>a.indexOf(c)===i);

      saveColsPrefs();
      renderTableHeader();
      render();
      updateColsCount();

      const meta = chk.closest(".col-item")?.querySelector(".col-meta");
      if (meta) meta.textContent = chk.checked ? "Visible" : "Oculta";
    });
  });
}

openColsBtn.addEventListener("click", openCols);
colsCloseBtn.addEventListener("click", closeCols);
colsBackdrop.addEventListener("click", closeCols);
window.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && colsSheet.classList.contains("show")) closeCols(); });
colsSearch.addEventListener("input", ()=> renderColsGrid());

colsAllBtn.addEventListener("click", ()=>{
  visibleCols = ALWAYS_COLS.concat(EXTRA_COLS.filter(c => !ALWAYS_COLS.includes(c)));
  visibleCols = visibleCols.filter((c,i,a)=>a.indexOf(c)===i);
  saveColsPrefs();
  renderTableHeader(); render();
  renderColsGrid(); updateColsCount();
});
colsNoneBtn.addEventListener("click", ()=>{
  visibleCols = ALWAYS_COLS.slice();
  saveColsPrefs();
  renderTableHeader(); render();
  renderColsGrid(); updateColsCount();
});
colsResetBtn.addEventListener("click", ()=>{
  visibleCols = ALWAYS_COLS.slice();
  saveColsPrefs();
  renderTableHeader(); render();
  renderColsGrid(); updateColsCount();
});

/* =====================
   Header din√°mico
===================== */
function renderTableHeader(){
  const cols = visibleCols.slice();
  const finalCols = cols.concat(["Acci√≥n"]);

  theadRow.innerHTML = finalCols.map(col=>{
    if (col === "Acci√≥n") return `<th>Acci√≥n</th>`;
    return `
      <th class="sortable" data-col="${col}">
        ${col} <span class="arrow" id="a-${col}"></span>
      </th>
    `;
  }).join("");

  document.querySelectorAll("th.sortable").forEach(th=>{
    th.addEventListener("click", ()=>{
      const col = th.getAttribute("data-col");
      cycleSort(col);
    });
  });

  updateArrows();
}

/* =====================
   Filtrado
===================== */
function getFiltered(){
  const f = norm(q.value);
  if (!f) return rows.slice();

  return rows.filter(r =>
    norm(r["Direcci√≥n"]).includes(f) ||
    norm(r["Barrio/Localidad"]).includes(f) ||
    norm(r["Telefono"]).includes(f) ||
    norm(r["Plan Internet"]).includes(f) ||
    norm(r["Comentario"]).includes(f)
  );
}

/* =====================
   Render rows
===================== */
function render(){
  const data = getFiltered();
  statusEl.textContent = `Mostrando ${data.length} de ${rows.length}`;

  const cols = visibleCols.slice();

  tb.innerHTML = data.map(r=>{
    const c = String(r["Comentario"]||"").trim();
    const markedRet = hasRetirado(c);

    let btnText = markedRet ? "CANCELAR" : "RETIRAR";
    let action  = markedRet ? "CANCELAR" : "RETIRADO";

    const tds = cols.map(col=>{
      let v = r[col];
      if ((v === undefined || v === null || v === "") && r._extra && r._extra[col] !== undefined){
        v = r._extra[col];
      }

      if (col === "Adeudos") return `<td><b>${v ?? ""}</b></td>`;

      if (col === "Comentario"){
        if (!c) return `<td><span class="muted">‚Äî</span></td>`;
        return `<td><span class="${markedRet ? "ok" : "muted"}">${c}</span></td>`;
      }

      // ‚úÖ IP clickable (solo si la columna se llama Ip / IP)
      if (/^ip$/i.test(String(col || "").trim())){
        const ip = String(v ?? "").trim();
        if (isIPv4(ip)){
          return `<td><a href="http://${ip}" target="_blank" rel="noopener noreferrer">${ip}</a></td>`;
        }
        return `<td>${v ?? ""}</td>`;
      }

      return `<td>${v ?? ""}</td>`;
    }).join("");

    const actionTd = `
      <td>
        <button onclick="toggleRetiro(${r._row}, '${action}')">
          ${btnText}
        </button>
      </td>
    `;

    return `<tr>${tds}${actionTd}</tr>`;
  }).join("");
}

/* =====================
   Sorting
===================== */
function applySort(col, mode){
  if (mode === 0){
    rows = rowsOriginal.slice();
    return;
  }

  const numericCols = new Set(["Plan Precio","Pagos Pendientes","Adeudos"]);

  rows.sort((a,b)=>{
    let av = a[col], bv = b[col];

    if ((av === undefined || av === null || av === "") && a._extra && a._extra[col] !== undefined) av = a._extra[col];
    if ((bv === undefined || bv === null || bv === "") && b._extra && b._extra[col] !== undefined) bv = b._extra[col];

    if (numericCols.has(col)){
      av = toNum(av); bv = toNum(bv);
      return mode === 1 ? (av - bv) : (bv - av);
    }

    av = norm(av); bv = norm(bv);
    if (av < bv) return mode === 1 ? -1 : 1;
    if (av > bv) return mode === 1 ? 1 : -1;
    return a._origIndex - b._origIndex;
  });
}

function updateArrows(){
  document.querySelectorAll("th.sortable").forEach(th=>{
    th.classList.remove("sort-active");
    const col = th.getAttribute("data-col");
    const span = document.getElementById("a-" + col);
    if (span) span.textContent = "";
  });

  if (!sortState.col) return;

  const th = document.querySelector(`th.sortable[data-col="${CSS.escape(sortState.col)}"]`);
  if (th) th.classList.add("sort-active");

  const span = document.getElementById("a-" + sortState.col);
  if (!span) return;

  span.textContent = sortState.mode === 1 ? "‚ñ≤" : sortState.mode === 2 ? "‚ñº" : "‚Ü∫";
}

function cycleSort(col){
  if (sortState.col !== col){
    sortState = { col, mode: 1 };
  } else {
    sortState.mode = (sortState.mode === 1) ? 2 : (sortState.mode === 2) ? 0 : 1;
  }
  applySort(sortState.col, sortState.mode);
  updateArrows();
  render();
}

/* =====================
   RETIRAR / CANCELAR
===================== */
async function toggleRetiro(row, action){
  if (action === "RETIRADO"){
    if(!confirm("¬øMarcar como RETIRADO? Se agregar√° 'RETIRADO' al comentario.")) return;
  } else if (action === "CANCELAR"){
    if(!confirm("¬øCancelar RETIRADO? Esto borrar√° TODO el comentario.")) return;
  }

  try{
    const res = await fetch(API_URL,{
      method:"POST",
      body: JSON.stringify({key:API_KEY,row,action})
    });

    const j = await res.json().catch(()=>({ok:false,error:"bad_json"}));

    if (!j.ok){
      alert("ERROR: " + (j.error || "unknown"));
      return;
    }
    await load();
  }catch(e){
    console.error(e);
    alert("ERROR de red / permisos.");
  }
}

/* =====================
   Load
===================== */
async function load(){
  statusEl.textContent = "Cargando‚Ä¶";
  const r = await fetch(API_URL + "?key=" + encodeURIComponent(API_KEY));
  const j = await r.json();
  if(!j.ok) throw j;

  rows = (j.rows || []).map((x,i)=> ({...x, _origIndex:i}));
  rowsOriginal = rows.slice();

  const sample = rows[0] || {};
  const extraObj = sample._extra || {};
  EXTRA_COLS = Object.keys(extraObj || {});

  loadColsPrefs();

  sortState = { col:null, mode:0 };

  renderTableHeader();
  updateArrows();
  render();

  hideSplash();
}

q.addEventListener("input", render);

load().catch((e)=>{
  console.error(e);
  statusEl.textContent="ERROR: API_KEY o permisos";
  hideSplash();
});

/* =====================
   Inicio
===================== */
(function init(){
  handleHashRoute(); // si entra directo con #whoami
})();
</script>

</body>
</html>
